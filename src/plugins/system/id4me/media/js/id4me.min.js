var Joomla = window.Joomla || {};

(function(document, Joomla)
{
  document.addEventListener('DOMContentLoaded', function()
  {
    Joomla.ID4Me = function(element, options)
    {
      var forms = [].slice.call(document.querySelectorAll(element));

      var buttonimage = options && options.buttonimage ? options.buttonimage : '/media/plg_system_id4me/img/id4me-login-button.svg';

      var options = Object.assign({
        template: '<div class="id4me-wrapper">' +
                    '<form class="id4me-form">' +
                      '<label>' + Joomla.JText._('PLG_SYSTEM_ID4ME_IDENTIFIER_LABEL') + '</label>' +
                      '<div class="id4me-fields id4me-hide row-fluid">' +
                        '<input type="text" class="span12" name="id4me-identifier">' +
                      '</div>' +
                      '<img src="' + buttonimage + '" alt="" class="id4me-button">' +
                    '</form>' +
                  '</div>',
        buttonClass: 'id4me-button',
        hideClass: 'id4me-hide',
      }, options);

      var appendID4MeButton = function(form)
      {
        form.insertAdjacentHTML('afterend', options.template);

        var id4me = form.nextElementSibling,
            button = id4me.querySelector('.' + options.buttonClass);

        button.addEventListener('click', function()
        {
          form.classList.add(options.hideClass);
          button.classList.add(options.hideClass);

          [].slice.call(id4me.querySelectorAll('.' + options.hideClass)).forEach(function(elem)
          {
            elem.classList.remove(options.hideClass);
          });
        })
      }

      forms.forEach(function(form)
      {
        appendID4MeButton(form);
      });
    }
  });
})(document, Joomla);
